
import React, { useState } from 'react';

interface VulnerabilityManagementPBQProps {
  onComplete: (score: number) => void;
  onExit: () => void;
}

interface Vuln {
  id: string;
  name: string;
  cvss: number;
  impact: 'High' | 'Medium' | 'Low';
  exploit: boolean;
}

const VULNS: Vuln[] = [
    { id: 'CVE-2024-1234', name: 'Apache RCE', cvss: 9.8, impact: 'High', exploit: true },
    { id: 'CVE-2024-5678', name: 'MySQL Priv Esc', cvss: 8.8, impact: 'High', exploit: true },
    { id: 'CVE-2023-1111', name: 'Java Deserialization', cvss: 9.0, impact: 'High', exploit: false }, // High CVSS but no public exploit (in this scenario)
    { id: 'CVE-2024-9012', name: 'SMB Info Disclosure', cvss: 7.5, impact: 'Medium', exploit: false },
    { id: 'CVE-2024-7890', name: 'Outdated TLS', cvss: 5.3, impact: 'Medium', exploit: false }
];

// Correct order: Critical+Exploit -> High+Exploit -> High/Crit no exploit -> Medium
const CORRECT_ORDER = ['CVE-2024-1234', 'CVE-2024-5678', 'CVE-2023-1111', 'CVE-2024-9012', 'CVE-2024-7890'];

const VulnerabilityManagementPBQ: React.FC<VulnerabilityManagementPBQProps> = ({ onComplete, onExit }) => {
  // Start scrambled
  const [items, setItems] = useState<Vuln[]>([...VULNS].sort(() => 0.5 - Math.random()));
  const [feedback, setFeedback] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const moveItem = (idx: number, direction: 'up' | 'down') => {
    const newItems = [...items];
    if (direction === 'up' && idx > 0) {
        [newItems[idx], newItems[idx - 1]] = [newItems[idx - 1], newItems[idx]];
    } else if (direction === 'down' && idx < newItems.length - 1) {
        [newItems[idx], newItems[idx + 1]] = [newItems[idx + 1], newItems[idx]];
    }
    setItems(newItems);
  };

  const handleSubmit = () => {
    let correctPositions = 0;
    items.forEach((item, idx) => {
        if (item.id === CORRECT_ORDER[idx]) correctPositions++;
    });

    const score = Math.round((correctPositions / items.length) * 100);
    setSuccess(score === 100);
    setFeedback(score === 100 
        ? "Perfect! You correctly prioritized based on CVSS, Exploitability, and Business Impact." 
        : `Priority order incorrect. Score: ${score}%. Remember: Active exploits and High Business Impact generally trump pure CVSS scores.`);
    
    if (score === 100) onComplete(score);
  };

  return (
    <div className="fixed inset-0 bg-gray-100 z-50 flex flex-col animate-fadeIn overflow-y-auto">
      <div className="bg-white shadow-md p-4 sticky top-0 z-10 flex justify-between items-center border-b border-gray-200">
        <div className="flex items-center gap-3">
            <div className="bg-blue-600 text-white p-2 rounded-lg shadow-sm"><i className="fas fa-bug"></i></div>
            <div><h2 className="text-xl font-bold text-gray-900">Vulnerability Prioritization</h2><p className="text-xs text-gray-500">Security+ PBQ Simulation</p></div>
        </div>
        <button onClick={onExit} className="text-gray-400 hover:text-gray-700 p-2 rounded-full"><i className="fas fa-times text-2xl"></i></button>
      </div>

      <div className="flex-grow p-8 max-w-3xl mx-auto w-full">
        <div className="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-8">
            <h3 className="font-bold text-blue-900 mb-2">Instructions</h3>
            <p className="text-blue-800 text-sm">Reorder the vulnerabilities below from <strong className="text-red-600">Highest Priority (Top)</strong> to <strong>Lowest Priority (Bottom)</strong>.</p>
            <p className="text-blue-800 text-sm mt-2">Consider CVSS Score, Business Impact, and Exploit Availability.</p>
        </div>

        <div className="space-y-3">
            {items.map((vuln, idx) => (
                <div key={vuln.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between transition-all hover:shadow-md">
                    <div className="flex items-center gap-4">
                        <div className="text-2xl font-bold text-gray-300 w-8 text-center">{idx + 1}</div>
                        <div>
                            <div className="flex items-center gap-3">
                                <span className="font-bold text-gray-800">{vuln.id}</span>
                                <span className={`text-xs px-2 py-0.5 rounded font-bold ${vuln.cvss >= 9 ? 'bg-red-100 text-red-800' : vuln.cvss >= 7 ? 'bg-orange-100 text-orange-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                    CVSS {vuln.cvss}
                                </span>
                            </div>
                            <div className="text-sm text-gray-600 mt-1">{vuln.name}</div>
                            <div className="text-xs text-gray-500 mt-1 flex gap-2">
                                <span>Impact: {vuln.impact}</span>
                                {vuln.exploit && <span className="text-red-600 font-bold flex items-center gap-1"><i className="fas fa-bolt"></i> Exploit Available</span>}
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-col gap-1">
                        <button onClick={() => moveItem(idx, 'up')} disabled={idx === 0} className="p-1 text-gray-400 hover:text-blue-600 disabled:opacity-30"><i className="fas fa-chevron-up"></i></button>
                        <button onClick={() => moveItem(idx, 'down')} disabled={idx === items.length - 1} className="p-1 text-gray-400 hover:text-blue-600 disabled:opacity-30"><i className="fas fa-chevron-down"></i></button>
                    </div>
                </div>
            ))}
        </div>

        <div className="mt-8 flex justify-end">
            <button onClick={handleSubmit} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition-all">Validate Order</button>
        </div>
      </div>

      {feedback && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div className="bg-white p-8 rounded-xl max-w-md text-center">
                <h3 className={`text-xl font-bold mb-4 ${success ? 'text-green-600' : 'text-red-600'}`}>{success ? 'Success!' : 'Incorrect Order'}</h3>
                <p className="mb-6">{feedback}</p>
                <button onClick={() => success ? onExit() : setFeedback(null)} className="px-6 py-2 bg-gray-800 text-white rounded">OK</button>
            </div>
        </div>
      )}
    </div>
  );
};

export default VulnerabilityManagementPBQ;
